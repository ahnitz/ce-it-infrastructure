version: '3.7'

services:
    dcc:
        image: cosmicexplorer/dcc:3.3.0
        environment:
            - DCC_HOSTNAME=${DCC_HOSTNAME}
        volumes:
            - ${STORAGE_PATH}/etc/shibboleth/shibboleth2.xml:/etc/shibboleth/shibboleth2.xml
            - ${STORAGE_PATH}/etc/shibboleth/attribute-map.xml:/etc/shibboleth/attribute-map.xml
            - ${STORAGE_PATH}/etc/shibboleth/inc-md-cert.pem:/etc/shibboleth/inc-md-cert.pem
            - ${STORAGE_PATH}/usr1/www/html/DocDB:/usr1/www/html/DocDB
            - ${STORAGE_PATH}/usr1/www/html/public:/usr1/www/html/public
            - ${STORAGE_PATH}/var/lib/mysql:/var/lib/mysql
            - ${STORAGE_PATH}/usr2/GLIMPSE:/usr2/GLIMPSE
            - ${STORAGE_PATH}/letsencrypt/config/etc/letsencrypt:/etc/letsencrypt
        secrets:
            - shibboleth_sp_encrypt_cert
            - shibboleth_sp_encrypt_privkey
            - mysql_root_passwd
            - mysql_docdbrw_passwd
            - mysql_docdbro_passwd
            - shib_header_secret
            - rest_authorized_eppn
        networks:
            dcc-bridge:
                ipv4_address: 192.168.101.3
            dcc-net: {}
        ports:
            - "128.230.146.13:443:443"
        hostname: ${DCC_INSTANCE}
        dns:
            - 208.67.222.222
            - 208.67.220.220
        restart: always

networks:
    roster-net:
        external: true
        name: roster_roster-net
    roster-bridge:
        external: true
        name: roster_roster-bridge

secrets:
    shibboleth_sp_encrypt_cert:
        file: ./shibboleth_sp_encrypt_cert.txt
    shibboleth_sp_encrypt_privkey:
        file: ./shibboleth_sp_encrypt_privkey.txt
    mysql_root_passwd:
        file: ./mysql_root_passwd.txt
    mysql_docdbrw_passwd:
        external: ./mysql_docdbrw_passwd.txt
    mysql_docdbro_passwd:
        external: ./mysql_docdbro_passwd.txt
    shib_header_secret:
        external: ./shib_header_secret.txt
    rest_authorized_eppn:
        external: ./rest_authorized_eppn.txt
